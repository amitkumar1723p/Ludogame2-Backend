name: Deploy Ludo Backend #   Pipeline ka naam

on:
  push:
    branches: [main] #   Jab bhi main branch pe push hoga, yeh pipeline trigger hogi

jobs:
  build: #    Pehla job: Docker image build & push
    runs-on: ubuntu-latest #   Job ek fresh Ubuntu runner pe chalega
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4 #   Repo ka latest code checkout karega

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
        #   DockerHub me login karne ke liye GitHub secrets use karega

      - name: Build Docker Image
        run: |
          docker build \
            -t ${{ secrets.DOCKER_USERNAME }}/ludo-backend:latest .
        #   Docker image build karega aur "latest" tag ke sath banayega

      - name: Push Docker Image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/ludo-backend:latest
        #   Banayi gayi image ko DockerHub pe push karega

  deploy: #   Dusra job: Deploy on EC2
    needs: build #   Yeh job tab chalega jab build job complete ho jayega
    runs-on: ubuntu-latest #   Yeh bhi ek Ubuntu runner pe chalega
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.10 #   GitHub Action jo SSH se EC2 connect karta hai
        with:
          host: ${{ secrets.EC2_HOST }} #   EC2 ka public IP (GitHub secret me store hai)
          username: ${{ secrets.EC2_USER }} #   SSH username (jaise ubuntu)
          key: ${{ secrets.EC2_KEY }} #   SSH private key (PEM file ka content)
          script: | #   Yeh script EC2 pe execute hogi



            # ✅ Step 1: .env file generate karo (jitne bhi secrets hain unko inject karke)
            cat > .env <<EOF
            PORT=${{ secrets.PORT }}
            TESTING=${{ secrets.TESTING }}
            MONGODB=${{ secrets.MONGODB }}
            EOF

            # ✅ Step 2: Container stop/remove if exists
            docker stop ludo-backend || true
            docker rm ludo-backend || true

            # ✅ Step 3: Pull latest image
            docker pull ${{ secrets.DOCKER_USERNAME }}/ludo-backend:latest

            # ✅ Step 4: Run container with --env-file
            docker run -d --name ludo-backend --restart unless-stopped \
              -p 3000:3000 \
              --env-file .env \
              ${{ secrets.DOCKER_USERNAME }}/ludo-backend:latest

            # ✅ Step 5: Cleanup old unused images
            docker image prune -f
