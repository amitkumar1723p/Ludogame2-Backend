# ===========================
# Workflow: Deploy Ludo Backend to EC2
# ===========================

# Jab bhi 'main' branch me push hoti hai tab ye workflow chalega
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    # Ye job GitHub ke hosted ubuntu server (runner) par chalegi
    runs-on: ubuntu-latest

    steps:
      # Step 1: Repo ka latest code checkout karo
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: SSH ke through :contentReference[oaicite:0]{index=0} instance me connect karke commands run karo
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          # EC2 public IP (GitHub Secrets me stored)
          host: ${{ secrets.EC2_HOST }}
          # EC2 username (usually 'ubuntu' for Ubuntu AMI)
          username: ${{ secrets.EC2_USER }}
          # EC2 private key ka content (GitHub Secret me saved)
          key: ${{ secrets.EC2_KEY }}
          # Ye commands EC2 par remotely run hongi
          script: |
            # Project folder me jao
            cd /home/ubuntu/Ludogame2-Backend

            # Latest code pull karo 'main' branch se
            git fetch origin
            git checkout main
            git pull origin main

            # Node packages install/update karo
            npm install

            # Server restart karo using :contentReference[oaicite:1]{index=1} (agar pehle se running ho to restart, warna start)
            npx pm2 restart all || npx pm2 start server.js --name "ludo-server"
